# Migration `20191203170022-bootstrap-schema`

This migration has been generated by simonvadee at 12/3/2019, 5:00:22 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "pyrog"."Template" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "id" text NOT NULL  ,
  "name" text NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."Source" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "hasOwner" boolean NOT NULL DEFAULT false ,
  "id" text NOT NULL  ,
  "name" text NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "version" text   ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."Credential" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "database" text NOT NULL DEFAULT '' ,
  "host" text NOT NULL DEFAULT '' ,
  "id" text NOT NULL  ,
  "login" text NOT NULL DEFAULT '' ,
  "model" text NOT NULL DEFAULT 'POSTGRES' ,
  "password" text NOT NULL DEFAULT '' ,
  "port" text NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."Resource" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "fhirType" text NOT NULL DEFAULT '' ,
  "id" text NOT NULL  ,
  "profile" text   ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."Attribute" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "description" text NOT NULL DEFAULT '' ,
  "fhirType" text NOT NULL DEFAULT '' ,
  "id" text NOT NULL  ,
  "isArray" boolean NOT NULL DEFAULT false ,
  "mergingScript" text   ,
  "name" text NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."Input" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "id" text NOT NULL  ,
  "script" text NOT NULL DEFAULT '' ,
  "staticValue" text NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."Column" (
  "column" text   ,
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "id" text NOT NULL  ,
  "owner" text   ,
  "table" text   ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."Join" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "id" text NOT NULL  ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."User" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "email" text NOT NULL DEFAULT '' ,
  "id" text NOT NULL  ,
  "name" text NOT NULL DEFAULT '' ,
  "password" text NOT NULL DEFAULT '' ,
  "role" text NOT NULL DEFAULT 'USER' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."_ColumnToJoin" (
  "A" text NOT NULL  REFERENCES "pyrog"."Column"("id") ON DELETE CASCADE,
  "B" text NOT NULL  REFERENCES "pyrog"."Join"("id") ON DELETE CASCADE
);

ALTER TABLE "pyrog"."Source" ADD COLUMN "template" text NOT NULL  REFERENCES "pyrog"."Template"("id") ON DELETE RESTRICT;

ALTER TABLE "pyrog"."Credential" ADD COLUMN "source" text NOT NULL  REFERENCES "pyrog"."Source"("id") ON DELETE RESTRICT;

ALTER TABLE "pyrog"."Resource" ADD COLUMN "source" text NOT NULL  REFERENCES "pyrog"."Source"("id") ON DELETE RESTRICT;

ALTER TABLE "pyrog"."Attribute" ADD COLUMN "parent" text   REFERENCES "pyrog"."Attribute"("id") ON DELETE SET NULL,
ADD COLUMN "resource" text NOT NULL  REFERENCES "pyrog"."Resource"("id") ON DELETE RESTRICT;

ALTER TABLE "pyrog"."Input" ADD COLUMN "attribute" text NOT NULL  REFERENCES "pyrog"."Attribute"("id") ON DELETE RESTRICT,
ADD COLUMN "sqlValue" text NOT NULL  REFERENCES "pyrog"."Column"("id") ON DELETE RESTRICT;

CREATE UNIQUE INDEX "Template.name" ON "pyrog"."Template"("name")

CREATE UNIQUE INDEX "Source.name" ON "pyrog"."Source"("name")

CREATE UNIQUE INDEX "User.email" ON "pyrog"."User"("email")

CREATE UNIQUE INDEX "_ColumnToJoin_AB_unique" ON "pyrog"."_ColumnToJoin"("A","B")
```

## Changes

```diff
diff --git datamodel.mdl datamodel.mdl
migration ..20191203170022-bootstrap-schema
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,133 @@
+generator photon {
+  provider = "photonjs"
+}
+
+datasource db {
+  provider = "postgresql"
+  url      = "postgresql://prisma:prisma@localhost:5432/prisma?schema=pyrog"
+}
+
+// One per software (Chimio, Crossway, etc)
+model Template {
+  id      String   @default(cuid()) @id
+  name    String   @unique
+  sources Source[] @relation(onDelete: CASCADE)
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+model Source {
+  id         String      @default(cuid()) @id
+  name       String      @unique
+  version    String?
+  hasOwner   Boolean     @default(false)
+  resources  Resource[]  @relation(onDelete: CASCADE)
+  credential Credential? @relation(onDelete: CASCADE)
+  template   Template
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+enum DatabaseType {
+  POSTGRES
+}
+
+model Credential {
+  id       String       @default(cuid()) @id
+  host     String
+  port     String
+  database String
+  login    String
+  password String
+  model    DatabaseType
+  // Parent
+  source   Source
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+model Resource {
+  id         String      @default(cuid()) @id
+  profile    String?
+  fhirType   String
+  attributes Attribute[] @relation(onDelete: CASCADE)
+  // Parent
+  source     Source
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+model Attribute {
+  id            String      @default(cuid()) @id
+  name          String
+  mergingScript String?
+  isArray       Boolean     @default(false)
+  fhirType      String
+  description   String
+  // Children input columns
+  inputs        Input[]     @relation(onDelete: CASCADE)
+  // Children attributes
+  children      Attribute[] @relation(name: "AttributeToAttributes", onDelete: CASCADE)
+  // Parent attribute or resource
+  parent        Attribute?  @relation(name: "AttributeToAttributes")
+  resource      Resource
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+model Input {
+  id          String    @default(cuid()) @id
+  // Sql column containing the value
+  sqlValue    Column
+  // cleaning scripts for the sql column
+  script      String
+  // Or a static value is it's fixed
+  staticValue String
+  // parent
+  attribute   Attribute
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+model Column {
+  id     String  @default(cuid()) @id
+  owner  String?
+  table  String?
+  column String?
+
+  joins Join[] @relation(onDelete: CASCADE)
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+model Join {
+  id String @default(cuid()) @id
+
+  tables Column[]
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+enum Role {
+  ADMIN
+  USER
+}
+
+model User {
+  id       String @default(cuid()) @id
+  email    String @unique
+  name     String
+  password String
+  role     Role   @default(USER)
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
```

## Photon Usage

You can use a specific Photon built for this migration (20191203170022-bootstrap-schema)
in your `before` or `after` migration script like this:

```ts
import Photon from '@generated/photon/20191203170022-bootstrap-schema'

const photon = new Photon()

async function main() {
  const result = await photon.users()
  console.dir(result, { depth: null })
}

main()
```
