# Migration `20191129150628-bootstrap-schema`

This migration has been generated by simonvadee at 11/29/2019, 3:06:28 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "pyrog"."Source" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "hasOwner" boolean NOT NULL DEFAULT false ,
  "id" text NOT NULL  ,
  "name" text NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."Credential" (
  "database" text NOT NULL DEFAULT '' ,
  "host" text NOT NULL DEFAULT '' ,
  "id" text NOT NULL  ,
  "login" text NOT NULL DEFAULT '' ,
  "model" text NOT NULL DEFAULT 'POSTGRES' ,
  "password" text NOT NULL DEFAULT '' ,
  "port" text NOT NULL DEFAULT '' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."Resource" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "fhirType" text NOT NULL DEFAULT '' ,
  "id" text NOT NULL  ,
  "label" text NOT NULL DEFAULT '' ,
  "primaryKeyColumn" text   ,
  "primaryKeyOwner" text   ,
  "primaryKeyTable" text   ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."Attribute" (
  "comment" text   ,
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "depth" integer   ,
  "id" text NOT NULL  ,
  "isProfile" boolean   ,
  "mergingScript" text   ,
  "model" text   ,
  "name" text NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."InputColumn" (
  "column" text NOT NULL DEFAULT '' ,
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "id" text NOT NULL  ,
  "owner" text NOT NULL DEFAULT '' ,
  "script" text NOT NULL DEFAULT '' ,
  "staticValue" text NOT NULL DEFAULT '' ,
  "table" text NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."Join" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "id" text NOT NULL  ,
  "sourceColumn" text NOT NULL DEFAULT '' ,
  "sourceOwner" text NOT NULL DEFAULT '' ,
  "sourceTable" text NOT NULL DEFAULT '' ,
  "targetColumn" text NOT NULL DEFAULT '' ,
  "targetOwner" text NOT NULL DEFAULT '' ,
  "targetTable" text NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "pyrog"."User" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "email" text NOT NULL DEFAULT '' ,
  "id" text NOT NULL  ,
  "name" text NOT NULL DEFAULT '' ,
  "password" text NOT NULL DEFAULT '' ,
  "role" text NOT NULL DEFAULT 'USER' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

ALTER TABLE "pyrog"."Credential" ADD COLUMN "source" text NOT NULL  REFERENCES "pyrog"."Source"("id") ON DELETE RESTRICT,
ADD COLUMN "user" text   REFERENCES "pyrog"."User"("id") ON DELETE SET NULL;

ALTER TABLE "pyrog"."Resource" ADD COLUMN "source" text NOT NULL  REFERENCES "pyrog"."Source"("id") ON DELETE RESTRICT;

ALTER TABLE "pyrog"."Attribute" ADD COLUMN "attribute" text   REFERENCES "pyrog"."Attribute"("id") ON DELETE SET NULL,
ADD COLUMN "resource" text   REFERENCES "pyrog"."Resource"("id") ON DELETE SET NULL;

ALTER TABLE "pyrog"."InputColumn" ADD COLUMN "attribute" text NOT NULL  REFERENCES "pyrog"."Attribute"("id") ON DELETE RESTRICT;

ALTER TABLE "pyrog"."Join" ADD COLUMN "inputColumn" text NOT NULL  REFERENCES "pyrog"."InputColumn"("id") ON DELETE RESTRICT;

CREATE UNIQUE INDEX "Source.name" ON "pyrog"."Source"("name")

CREATE UNIQUE INDEX "User.email" ON "pyrog"."User"("email")
```

## Changes

```diff
diff --git datamodel.mdl datamodel.mdl
migration ..20191129150628-bootstrap-schema
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,112 @@
+generator photon {
+  provider = "photonjs"
+  output   = "../src/generated/photon"
+}
+
+datasource db {
+  provider = "postgresql"
+  url      = "postgresql://prisma:prisma@localhost:5432/prisma?schema=pyrog"
+}
+
+model Source {
+  id         String      @default(cuid()) @id
+  name       String      @unique
+  hasOwner   Boolean     @default(false)
+  resources  Resource[]  @relation(name: "SourceToResource", onDelete: CASCADE)
+  updatedAt  DateTime    @updatedAt
+  createdAt  DateTime    @default(now())
+  credential Credential? @relation(name: "SourceToCredential", onDelete: CASCADE)
+}
+
+enum DatabaseType {
+  POSTGRES
+}
+
+model Credential {
+  id       String       @default(cuid()) @id
+  host     String
+  port     String
+  database String
+  login    String
+  password String
+  model    DatabaseType
+  source   Source       @relation(name: "SourceToCredential")
+}
+
+model Resource {
+  id               String      @default(cuid()) @id
+  label            String
+  fhirType         String
+  primaryKeyOwner  String?
+  primaryKeyTable  String?
+  primaryKeyColumn String?
+  attributes       Attribute[] @relation(name: "ResourceToAttributes", onDelete: CASCADE)
+  source           Source      @relation(name: "SourceToResource")
+  updatedAt        DateTime    @updatedAt
+  createdAt        DateTime    @default(now())
+}
+
+model Attribute {
+  id            String        @default(cuid()) @id
+  name          String
+  mergingScript String?
+  isProfile     Boolean?
+  model         String?
+  comment       String?
+  depth         Int?
+  // Parent resource
+  resource      Resource?     @relation(name: "ResourceToAttributes")
+  // Children attributes
+  attributes    Attribute[]   @relation(name: "AttributeToAttributes", onDelete: CASCADE)
+  // Parent attribute
+  attribute     Attribute?    @relation(name: "AttributeToAttributes")
+  // Children input columns
+  inputColumns  InputColumn[] @relation(name: "AttributeToInputColumns", onDelete: CASCADE)
+  updatedAt     DateTime      @updatedAt
+  createdAt     DateTime      @default(now())
+}
+
+model InputColumn {
+  id          String    @default(cuid()) @id
+  owner       String
+  table       String
+  column      String
+  script      String
+  staticValue String
+  // Children joins
+  joins       Join[]    @relation(name: "InputColumnToJoins", onDelete: CASCADE)
+  // Parent attribute
+  attribute   Attribute @relation(name: "AttributeToInputColumns")
+  updatedAt   DateTime  @updatedAt
+  createdAt   DateTime  @default(now())
+}
+
+model Join {
+  id           String      @default(cuid()) @id
+  sourceOwner  String
+  sourceTable  String
+  sourceColumn String
+  targetOwner  String
+  targetTable  String
+  targetColumn String
+  // Parent input column
+  inputColumn  InputColumn @relation(name: "InputColumnToJoins")
+  updatedAt    DateTime    @updatedAt
+  createdAt    DateTime    @default(now())
+}
+
+enum Role {
+  ADMIN
+  USER
+}
+
+model User {
+  id          String       @default(cuid()) @id
+  email       String       @unique
+  name        String
+  password    String
+  role        Role         @default(USER)
+  updatedAt   DateTime     @updatedAt
+  createdAt   DateTime     @default(now())
+  credentials Credential[]
+}
```

## Photon Usage

You can use a specific Photon built for this migration (20191129150628-bootstrap-schema)
in your `before` or `after` migration script like this:

```ts
import Photon from '@generated/photon/20191129150628-bootstrap-schema'

const photon = new Photon()

async function main() {
  const result = await photon.users()
  console.dir(result, { depth: null })
}

main()
```
