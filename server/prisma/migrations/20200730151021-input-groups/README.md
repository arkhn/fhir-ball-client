# Migration `20200730151021-input-groups`

This migration has been generated by Jasopaum at 7/30/2020, 3:10:21 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "ConditionAction" AS ENUM ('INCLUDE', 'EXCLUDE');

CREATE TABLE "pyrog"."InputGroup" (
"attributeId" text   ,"condition" text   ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" text  NOT NULL ,"mergingScript" text   ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "pyrog"."Condition" (
"action" "ConditionAction" NOT NULL ,"column" text  NOT NULL ,"id" text  NOT NULL ,
    PRIMARY KEY ("id"))

ALTER TABLE "pyrog"."Attribute" DROP COLUMN "mergingScript";

ALTER TABLE "pyrog"."Input" DROP CONSTRAINT IF EXiSTS "Input_attribute_fkey",
DROP COLUMN "attribute",
ADD COLUMN "inputGroupId" text   ;

ALTER TABLE "pyrog"."User" ALTER COLUMN "role" SET DEFAULT E'USER';

CREATE UNIQUE INDEX "Condition_column" ON "pyrog"."Condition"("column")

ALTER TABLE "pyrog"."InputGroup" ADD FOREIGN KEY ("condition")REFERENCES "pyrog"."Condition"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "pyrog"."InputGroup" ADD FOREIGN KEY ("attributeId")REFERENCES "pyrog"."Attribute"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "pyrog"."Condition" ADD FOREIGN KEY ("column")REFERENCES "pyrog"."Column"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "pyrog"."Input" ADD FOREIGN KEY ("inputGroupId")REFERENCES "pyrog"."InputGroup"("id") ON DELETE SET NULL  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200623144855-database-schema..20200730151021-input-groups
--- datamodel.dml
+++ datamodel.dml
@@ -3,9 +3,9 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url      = env("POSTGRES_URL")
 }
 // One per software (Chimio, Crossway, etc)
 model Template {
@@ -78,19 +78,18 @@
   sqlColumn   Column    @relation(fields: [sqlColumnId], references: [id])
 }
 model Attribute {
-  id            String    @default(cuid()) @id
+  id            String       @default(cuid()) @id
   path          String
   sliceName     String?
   definitionId  String
-  mergingScript String?
   comments      Comment[]
-  inputs        Input[]
-  resourceId    String?   @map("resource")
-  resource      Resource? @relation(fields: [resourceId], references: [id])
-  updatedAt     DateTime  @updatedAt
-  createdAt     DateTime  @default(now())
+  inputGroups   InputGroup[]
+  resourceId    String?      @map("resource")
+  resource      Resource?    @relation(fields: [resourceId], references: [id])
+  updatedAt     DateTime     @updatedAt
+  createdAt     DateTime     @default(now())
 }
 model Comment {
   id          String     @default(cuid()) @id
@@ -103,37 +102,50 @@
   updatedAt   DateTime   @updatedAt
   createdAt   DateTime   @default(now())
 }
+model InputGroup {
+  id            String     @default(cuid()) @id
+  inputs        Input[]
+  mergingScript String?
+  conditionId   String?    @map("condition")
+  condition     Condition? @relation("inputCondition", fields: [conditionId], references: [id])
+  Attribute     Attribute? @relation(fields: [attributeId], references: [id])
+  attributeId   String?
+  updatedAt     DateTime   @updatedAt
+  createdAt     DateTime   @default(now())
+}
+
 model Input {
-  id           String    @default(cuid()) @id
+  id           String      @default(cuid()) @id
   // cleaning scripts for the sql column
   script       String?
   // id of the concept map to be applied to a mapped code
   conceptMapId String?
   // Or a static value is it's fixed
   staticValue  String?
-  // parent
-  attributeId  String    @map("attribute")
-  attribute    Attribute @relation(fields: [attributeId], references: [id])
   // Sql column containing the value
-  sqlValueId   String?   @map("sqlValue")
-  sqlValue     Column?   @relation(fields: [sqlValueId], references: [id])
-  updatedAt    DateTime  @updatedAt
-  createdAt    DateTime  @default(now())
+  sqlValueId   String?     @map("sqlValue")
+  sqlValue     Column?     @relation(fields: [sqlValueId], references: [id])
+  // Group to which this input belongs
+  InputGroup   InputGroup? @relation(fields: [inputGroupId], references: [id])
+  inputGroupId String?
+  updatedAt    DateTime    @updatedAt
+  createdAt    DateTime    @default(now())
 }
 model Column {
-  id        String   @default(cuid()) @id
+  id        String     @default(cuid()) @id
   table     String?
   column    String?
-  joins     Join[]   @relation("ColumnJoins")
+  joins     Join[]     @relation("ColumnJoins")
   filter    Filter?
+  condition Condition?
   input     Input?
-  joinId    String?  @map("join")
-  join      Join?    @relation("JoinedColumns", fields: [joinId], references: [id])
-  updatedAt DateTime @updatedAt
-  createdAt DateTime @default(now())
+  joinId    String?    @map("join")
+  join      Join?      @relation("JoinedColumns", fields: [joinId], references: [id])
+  updatedAt DateTime   @updatedAt
+  createdAt DateTime   @default(now())
 }
 model Join {
   id        String   @default(cuid()) @id
@@ -143,8 +155,21 @@
   updatedAt DateTime @updatedAt
   createdAt DateTime @default(now())
 }
+enum ConditionAction {
+  INCLUDE
+  EXCLUDE
+}
+
+model Condition {
+  id         String          @default(cuid()) @id
+  action     ConditionAction
+  columnId   String          @map("column")
+  column     Column          @relation(fields: [columnId], references: [id])
+  InputGroup InputGroup[]    @relation("inputCondition")
+}
+
 enum Role {
   ADMIN
   USER
 }
```


