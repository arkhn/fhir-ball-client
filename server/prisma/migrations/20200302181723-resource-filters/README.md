# Migration `20200302181723-resource-filters`

This migration has been generated by Jasopaum at 3/2/2020, 6:17:23 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "pyrog"."Filter" (
  "id" text  NOT NULL  ,
  "relation" text  NOT NULL DEFAULT '' ,
  "resource" text    REFERENCES "pyrog"."Resource"("id") ON DELETE SET NULL,
  "sqlColumn" text  NOT NULL  REFERENCES "pyrog"."Column"("id") ON DELETE RESTRICT,
  "value" text  NOT NULL DEFAULT '' ,
  PRIMARY KEY ("id")
);

CREATE UNIQUE INDEX "Filter_sqlColumn" ON "pyrog"."Filter"("sqlColumn")

CREATE UNIQUE INDEX "Input_sqlValue" ON "pyrog"."Input"("sqlValue")
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200218162146-concept-maps..20200302181723-resource-filters
--- datamodel.dml
+++ datamodel.dml
@@ -3,9 +3,9 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url      = env("POSTGRES_URL")
 }
 // One per software (Chimio, Crossway, etc)
 model Template {
@@ -56,16 +56,27 @@
   primaryKeyOwner  String?
   primaryKeyTable  String?
   primaryKeyColumn String?
+  // filters on db to avoid processing all the DB
+  filters Filter[]
+
   attributes   Attribute[] @relation(onDelete: CASCADE)
   definitionId String
   source       Source
   updatedAt DateTime @updatedAt
   createdAt DateTime @default(now())
 }
+model Filter {
+  id String @default(cuid()) @id
+
+  sqlColumn Column @relation(references: [id])
+  relation  String
+  value     String
+}
+
 model Attribute {
   id            String  @default(cuid()) @id
   path          String
   mergingScript String?
@@ -80,9 +91,9 @@
 model Input {
   id           String    @default(cuid()) @id
   // Sql column containing the value
-  sqlValue     Column?   @relation(onDelete: CASCADE)
+  sqlValue     Column?   @relation(references: [id], onDelete: CASCADE)
   // cleaning scripts for the sql column
   script       String?
   // id of the concept map to be applied to a mapped code
   conceptMapId String?
@@ -102,8 +113,11 @@
   column String?
   joins Join[] @relation(name: "ColumnJoins", onDelete: CASCADE)
+  filter Filter?
+  input  Input?
+
   updatedAt DateTime @updatedAt
   createdAt DateTime @default(now())
 }
@@ -116,10 +130,9 @@
   createdAt DateTime @default(now())
 }
 enum Role {
-  ADMIN
-  USER
+  ADMIN USER
 }
 model User {
   id       String @default(cuid()) @id
```


