# Migration `20200107161936-bootstrap`

This migration has been generated by simonvadee at 1/7/2020, 4:19:36 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "public"."Template" (
  "createdAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "id" text  NOT NULL  ,
  "name" text  NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."Source" (
  "createdAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "hasOwner" boolean  NOT NULL DEFAULT false ,
  "id" text  NOT NULL  ,
  "name" text  NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "version" text    ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."Credential" (
  "createdAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "database" text  NOT NULL DEFAULT '' ,
  "host" text  NOT NULL DEFAULT '' ,
  "id" text  NOT NULL  ,
  "login" text  NOT NULL DEFAULT '' ,
  "model" text  NOT NULL DEFAULT 'POSTGRES' ,
  "password" text  NOT NULL DEFAULT '' ,
  "port" text  NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."Resource" (
  "createdAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "fhirType" text  NOT NULL DEFAULT '' ,
  "id" text  NOT NULL  ,
  "label" text    ,
  "primaryKeyColumn" text    ,
  "primaryKeyOwner" text    ,
  "primaryKeyTable" text    ,
  "profile" text    ,
  "updatedAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."Attribute" (
  "comments" text    ,
  "createdAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "description" text    ,
  "fhirType" text  NOT NULL DEFAULT '' ,
  "id" text  NOT NULL  ,
  "isArray" boolean  NOT NULL DEFAULT false ,
  "isRequired" boolean  NOT NULL DEFAULT false ,
  "mergingScript" text    ,
  "name" text  NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."Input" (
  "createdAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "id" text  NOT NULL  ,
  "script" text    ,
  "staticValue" text    ,
  "updatedAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."Column" (
  "column" text    ,
  "createdAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "id" text  NOT NULL  ,
  "owner" text    ,
  "table" text    ,
  "updatedAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."Join" (
  "createdAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "id" text  NOT NULL  ,
  "updatedAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."User" (
  "createdAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "email" text  NOT NULL DEFAULT '' ,
  "id" text  NOT NULL  ,
  "name" text  NOT NULL DEFAULT '' ,
  "password" text  NOT NULL DEFAULT '' ,
  "role" text  NOT NULL DEFAULT 'USER' ,
  "updatedAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

ALTER TABLE "public"."Source" ADD COLUMN "template" text  NOT NULL  REFERENCES "public"."Template"("id") ON DELETE RESTRICT;

ALTER TABLE "public"."Credential" ADD COLUMN "source" text  NOT NULL  REFERENCES "public"."Source"("id") ON DELETE RESTRICT;

ALTER TABLE "public"."Resource" ADD COLUMN "source" text  NOT NULL  REFERENCES "public"."Source"("id") ON DELETE RESTRICT;

ALTER TABLE "public"."Attribute" ADD COLUMN "parent" text    REFERENCES "public"."Attribute"("id") ON DELETE SET NULL,
ADD COLUMN "resource" text    REFERENCES "public"."Resource"("id") ON DELETE SET NULL;

ALTER TABLE "public"."Input" ADD COLUMN "attribute" text  NOT NULL  REFERENCES "public"."Attribute"("id") ON DELETE RESTRICT,
ADD COLUMN "sqlValue" text    REFERENCES "public"."Column"("id") ON DELETE SET NULL;

ALTER TABLE "public"."Column" ADD COLUMN "join" text    REFERENCES "public"."Join"("id") ON DELETE SET NULL;

ALTER TABLE "public"."Join" ADD COLUMN "column" text    REFERENCES "public"."Column"("id") ON DELETE SET NULL;

CREATE UNIQUE INDEX "Template.name" ON "public"."Template"("name")

CREATE UNIQUE INDEX "Source.name" ON "public"."Source"("name")

CREATE UNIQUE INDEX "Credential_source" ON "public"."Credential"("source")

CREATE UNIQUE INDEX "User.email" ON "public"."User"("email")
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20200107161936-bootstrap
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,139 @@
+generator client {
+  provider = "prisma-client-js"
+}
+
+datasource db {
+  provider = "postgresql"
+  url      = env("POSTGRES_URL")
+}
+
+// One per software (Chimio, Crossway, etc)
+model Template {
+  id      String   @default(cuid()) @id
+  name    String   @unique
+  sources Source[]
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+model Source {
+  id         String      @default(cuid()) @id
+  name       String      @unique
+  version    String?
+  hasOwner   Boolean     @default(false)
+  resources  Resource[]
+  credential Credential?
+  template   Template
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+model Credential {
+  id       String       @default(cuid()) @id
+  host     String
+  port     String
+  database String
+  login    String
+  password String
+  model    DatabaseType
+  // Parent
+  source   Source
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+enum DatabaseType {
+  POSTGRES
+}
+
+model Resource {
+  id               String      @default(cuid()) @id
+  label            String?
+  profile          String?
+  fhirType         String
+  primaryKeyOwner  String?
+  primaryKeyTable  String?
+  primaryKeyColumn String?
+  attributes       Attribute[]
+  // Parent
+  source           Source
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+model Attribute {
+  id            String      @default(cuid()) @id
+  mergingScript String?
+  isArray       Boolean     @default(false)
+  isRequired    Boolean     @default(false)
+  name          String
+  fhirType      String
+  description   String?
+  comments      String?
+  // Children input columns
+  inputs        Input[]
+  // Children attributes
+  children      Attribute[] @relation(name: "AttributeToAttributes")
+  // Parent attribute or resource
+  parent        Attribute?  @relation(name: "AttributeToAttributes")
+  resource      Resource?
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+model Input {
+  id          String    @default(cuid()) @id
+  // Sql column containing the value
+  sqlValue    Column?
+  // cleaning scripts for the sql column
+  script      String?
+  // Or a static value is it's fixed
+  staticValue String?
+  // parent
+  attribute   Attribute
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+model Column {
+  id     String  @default(cuid()) @id
+  owner  String?
+  table  String?
+  column String?
+
+  joins Join[] @relation(name: "ColumnJoins")
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+model Join {
+  id String @default(cuid()) @id
+
+  tables Column[] @relation(name: "JoinedColumns")
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
+
+enum Role {
+  ADMIN
+  USER
+}
+
+model User {
+  id       String @default(cuid()) @id
+  email    String @unique
+  name     String
+  password String
+  role     Role   @default(USER)
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
+}
```
