# Migration `20200327121708-cleanup-prisma-preview24`

This migration has been generated by simonvadee at 3/27/2020, 12:17:08 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
DROP INDEX "pyrog"."Column_filter"

ALTER TABLE "pyrog"."Column" DROP CONSTRAINT IF EXiSTS "Column_filter_fkey",
DROP COLUMN "filter";

ALTER TABLE "pyrog"."Filter" ADD COLUMN "sqlColumn" text  NOT NULL ;

CREATE UNIQUE INDEX "Filter_sqlColumn" ON "pyrog"."Filter"("sqlColumn")

ALTER TABLE "pyrog"."Filter" ADD FOREIGN KEY ("sqlColumn")REFERENCES "pyrog"."Column"("id") ON DELETE CASCADE  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200324142947-acl..20200327121708-cleanup-prisma-preview24
--- datamodel.dml
+++ datamodel.dml
@@ -3,85 +3,92 @@
 }
 datasource db {
   provider = "postgresql"
-  url      = "***"
+  url      = env("POSTGRES_URL")
 }
 // One per software (Chimio, Crossway, etc)
 model Template {
-  id        String   @default(cuid()) @id
-  name      String   @unique
-  sources   Source[]
+  id      String   @default(cuid()) @id
+  name    String   @unique
+  sources Source[]
+
   updatedAt DateTime @updatedAt
   createdAt DateTime @default(now())
 }
 model Source {
-  id             String          @default(cuid()) @id
-  name           String
-  version        String?
-  hasOwner       Boolean         @default(false)
-  resources      Resource[]
-  credential     Credential?
-  template       Template        @relation(references: [id])
-  updatedAt      DateTime        @updatedAt
-  createdAt      DateTime        @default(now())
-  accessControls AccessControl[]
+  id         String      @default(cuid()) @id
+  name       String
+  version    String?
+  hasOwner   Boolean     @default(false)
+  resources  Resource[]
+  credential Credential?
+  template   Template
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
 }
 enum DatabaseType {
-  POSTGRES
-  ORACLE
+  POSTGRES ORACLE
 }
 model Credential {
-  id        String       @default(cuid()) @id
-  host      String
-  port      String
-  database  String
-  login     String
-  password  String
-  model     DatabaseType
+  id       String       @default(cuid()) @id
+  host     String
+  port     String
+  database String
+  login    String
+  password String
+  model    DatabaseType
   // Parent
-  source    Source       @relation(references: [id])
-  updatedAt DateTime     @updatedAt
-  createdAt DateTime     @default(now())
+  source   Source
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
 }
 model Resource {
-  id               String      @default(cuid()) @id
-  label            String?
+  id    String  @default(cuid()) @id
+  label String?
+
   primaryKeyOwner  String?
   primaryKeyTable  String?
   primaryKeyColumn String?
+
   // filters on db to avoid processing all the DB
-  filters          Filter[]
-  attributes       Attribute[]
-  definitionId     String
-  source           Source      @relation(references: [id])
-  updatedAt        DateTime    @updatedAt
-  createdAt        DateTime    @default(now())
+  filters Filter[]
+
+  attributes   Attribute[]
+  definitionId String
+  source       Source
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
 }
 model Filter {
-  id        String    @default(cuid()) @id
-  sqlColumn Column    @relation(references: [id])
+  id String @default(cuid()) @id
+
+  sqlColumn Column @relation(references: [id])
   relation  String
   value     String
-  resource  Resource? @relation(references: [id])
 }
 model Attribute {
-  id            String    @default(cuid()) @id
+  id            String  @default(cuid()) @id
   path          String
   definitionId  String
   mergingScript String?
   comments      String?
-  inputs        Input[]
-  resource      Resource? @relation(references: [id])
-  updatedAt     DateTime  @updatedAt
-  createdAt     DateTime  @default(now())
+
+  inputs   Input[]
+  resource Resource?
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
 }
 model Input {
   id           String    @default(cuid()) @id
@@ -93,57 +100,60 @@
   conceptMapId String?
   // Or a static value is it's fixed
   staticValue  String?
   // parent
-  attribute    Attribute @relation(references: [id])
-  updatedAt    DateTime  @updatedAt
-  createdAt    DateTime  @default(now())
+  attribute    Attribute
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
 }
 model Column {
-  id        String   @default(cuid()) @id
-  owner     String?
-  table     String?
-  column    String?
-  joins     Join[]   @relation("ColumnJoins")
-  filter    Filter?
-  input     Input?
+  id     String  @default(cuid()) @id
+  owner  String?
+  table  String?
+  column String?
+
+  joins Join[] @relation(name: "ColumnJoins")
+
+  filter Filter?
+  input  Input?
+
   updatedAt DateTime @updatedAt
   createdAt DateTime @default(now())
-  join      Join?    @relation("JoinedColumns", references: [id])
 }
 model Join {
-  id        String   @default(cuid()) @id
-  tables    Column[] @relation("JoinedColumns")
+  id String @default(cuid()) @id
+
+  tables Column[] @relation(name: "JoinedColumns")
+
   updatedAt DateTime @updatedAt
   createdAt DateTime @default(now())
-  column    Column?  @relation("ColumnJoins", references: [id])
 }
 enum Role {
-  ADMIN
-  USER
+  ADMIN USER
 }
 model User {
-  id             String          @default(cuid()) @id
-  email          String          @unique
-  name           String
-  password       String
-  role           Role            @default(USER)
-  updatedAt      DateTime        @updatedAt
-  createdAt      DateTime        @default(now())
-  accessControls AccessControl[]
+  id       String @default(cuid()) @id
+  email    String @unique
+  name     String
+  password String
+  role     Role   @default(USER)
+
+  updatedAt DateTime @updatedAt
+  createdAt DateTime @default(now())
 }
 enum SourceRole {
-  READER
-  WRITER
+  READER WRITER
 }
 model AccessControl {
-  id     String     @default(cuid()) @id
-  user   User       @relation(references: [id])
-  source Source     @relation(references: [id])
+  id String @default(cuid()) @id
+
+  user   User
+  source Source
   role   SourceRole
 }
```


